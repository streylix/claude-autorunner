<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drag Event Flow Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1e1e1e;
            color: #ffffff;
        }

        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #444;
            border-radius: 8px;
        }

        .message-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            margin: 8px 0;
            background: #2a2a2a;
            border-radius: 8px;
            border: 1px solid #444;
            cursor: grab;
            position: relative;
        }

        .message-item:hover {
            background: #333;
        }

        .message-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .message-content {
            flex: 1;
            padding: 8px 0;
        }

        /* Current problematic CSS */
        .message-actions {
            display: flex;
            align-items: center;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none; /* Initially none */
            align-self: flex-start;
            flex-shrink: 0;
            min-height: 24px;
        }

        .message-item:hover .message-actions {
            opacity: 1;
            pointer-events: auto; /* This is the problem! */
        }

        .message-edit-btn, .message-delete-btn, .message-options-btn {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message-edit-btn:hover, .message-delete-btn:hover, .message-options-btn:hover {
            background: #444;
            color: #fff;
        }

        /* Fixed version CSS */
        .fixed .message-actions {
            pointer-events: auto; /* Always allow pointer events */
        }

        .fixed .message-actions button {
            pointer-events: auto; /* Buttons handle their own events */
        }

        .log {
            background: #0f0f0f;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }

        .drag-indicator {
            position: absolute;
            left: -10px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-size: 18px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .message-item:hover .drag-indicator {
            opacity: 1;
        }

        .event-counter {
            background: #333;
            padding: 8px;
            border-radius: 4px;
            margin: 5px 0;
            font-size: 14px;
        }

        .working { color: #4CAF50; }
        .broken { color: #f44336; }

        h2 {
            color: #4CAF50;
            border-bottom: 1px solid #444;
            padding-bottom: 8px;
        }

        .problem { color: #f44336; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Drag Event Flow Issue Analysis</h1>
        
        <div class="test-section">
            <h2 class="problem">Problem: Current Broken Implementation</h2>
            <p>When you hover over a message, the action buttons become visible with <code>pointer-events: auto</code>. 
            This blocks drag events from reaching the message element's event listeners.</p>
            
            <div id="broken-container">
                <div class="message-item" draggable="true" data-index="0">
                    <div class="drag-indicator">â‹®â‹®</div>
                    <div class="message-content">
                        <strong>Message 1:</strong> Try to drag this message by clicking and dragging anywhere on it.
                        Notice that dragging fails when you hover and the action buttons appear.
                    </div>
                    <div class="message-actions">
                        <button class="message-edit-btn" title="Edit">âœŽ</button>
                        <button class="message-delete-btn" title="Delete">ðŸ—‘</button>
                        <button class="message-options-btn" title="Options">â‹¯</button>
                    </div>
                </div>
                
                <div class="message-item" draggable="true" data-index="1">
                    <div class="drag-indicator">â‹®â‹®</div>
                    <div class="message-content">
                        <strong>Message 2:</strong> Another message to test drag and drop functionality.
                    </div>
                    <div class="message-actions">
                        <button class="message-edit-btn" title="Edit">âœŽ</button>
                        <button class="message-delete-btn" title="Delete">ðŸ—‘</button>
                        <button class="message-options-btn" title="Options">â‹¯</button>
                    </div>
                </div>
            </div>
            
            <div class="event-counter">
                <div>Drag Start Events: <span id="broken-dragstart">0</span></div>
                <div>Drag Over Events: <span id="broken-dragover">0</span></div>
                <div>Drop Events: <span id="broken-drop">0</span></div>
            </div>
        </div>

        <div class="test-section">
            <h2 class="working">Solution: Fixed Implementation</h2>
            <p>The fix involves changing the CSS to allow pointer-events on action buttons while ensuring 
            drag events can still bubble up from the message content area.</p>
            
            <div id="fixed-container" class="fixed">
                <div class="message-item" draggable="true" data-index="0">
                    <div class="drag-indicator">â‹®â‹®</div>
                    <div class="message-content">
                        <strong>Message 1:</strong> This version should work correctly - you can drag from the content area
                        and click buttons in the action area.
                    </div>
                    <div class="message-actions">
                        <button class="message-edit-btn" title="Edit">âœŽ</button>
                        <button class="message-delete-btn" title="Delete">ðŸ—‘</button>
                        <button class="message-options-btn" title="Options">â‹¯</button>
                    </div>
                </div>
                
                <div class="message-item" draggable="true" data-index="1">
                    <div class="drag-indicator">â‹®â‹®</div>
                    <div class="message-content">
                        <strong>Message 2:</strong> Drop zone for testing reordering functionality.
                    </div>
                    <div class="message-actions">
                        <button class="message-edit-btn" title="Edit">âœŽ</button>
                        <button class="message-delete-btn" title="Delete">ðŸ—‘</button>
                        <button class="message-options-btn" title="Options">â‹¯</button>
                    </div>
                </div>
            </div>
            
            <div class="event-counter">
                <div>Drag Start Events: <span id="fixed-dragstart">0</span></div>
                <div>Drag Over Events: <span id="fixed-dragover">0</span></div>
                <div>Drop Events: <span id="fixed-drop">0</span></div>
            </div>
        </div>

        <div class="test-section">
            <h2>Event Log</h2>
            <div id="event-log" class="log"></div>
            <button onclick="clearLog()">Clear Log</button>
        </div>

        <div class="test-section">
            <h2>Technical Analysis</h2>
            <h3>Root Cause:</h3>
            <ul>
                <li><strong>CSS Issue:</strong> <code>.message-item:hover .message-actions { pointer-events: auto; }</code></li>
                <li><strong>Event Blocking:</strong> When action buttons have <code>pointer-events: auto</code>, they intercept mouse events</li>
                <li><strong>Event Bubbling:</strong> Drag events starting on action buttons don't bubble to the message element</li>
            </ul>
            
            <h3>Solution Strategy:</h3>
            <ul>
                <li><strong>CSS Fix:</strong> Remove conditional <code>pointer-events</code> switching</li>
                <li><strong>Event Delegation:</strong> Handle drag events at container level</li>
                <li><strong>Selective Prevention:</strong> Only prevent drag when directly clicking buttons</li>
            </ul>
        </div>
    </div>

    <script>
        let draggedElement = null;
        let eventLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            eventLog.push(`[${timestamp}] ${message}`);
            updateLog();
        }

        function updateLog() {
            const logElement = document.getElementById('event-log');
            logElement.innerHTML = eventLog.slice(-20).join('\n');
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            eventLog = [];
            updateLog();
        }

        function setupDragHandlers(container, prefix) {
            const items = container.querySelectorAll('.message-item');
            const counters = {
                dragstart: document.getElementById(`${prefix}-dragstart`),
                dragover: document.getElementById(`${prefix}-dragover`),
                drop: document.getElementById(`${prefix}-drop`)
            };

            items.forEach(item => {
                // Drag start handler
                item.addEventListener('dragstart', (e) => {
                    const messageItem = e.target.closest('.message-item');
                    if (!messageItem) return;
                    
                    counters.dragstart.textContent = parseInt(counters.dragstart.textContent) + 1;
                    log(`${prefix.toUpperCase()}: Drag started on ${messageItem.dataset.index}`, 'success');
                    
                    draggedElement = messageItem;
                    messageItem.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', '');
                });

                // Drag over handler
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    
                    counters.dragover.textContent = parseInt(counters.dragover.textContent) + 1;
                    
                    const target = e.target.closest('.message-item');
                    if (target && target !== draggedElement) {
                        log(`${prefix.toUpperCase()}: Drag over ${target.dataset.index}`);
                    }
                });

                // Drop handler
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    counters.drop.textContent = parseInt(counters.drop.textContent) + 1;
                    
                    const target = e.target.closest('.message-item');
                    if (target && draggedElement && target !== draggedElement) {
                        log(`${prefix.toUpperCase()}: Dropped ${draggedElement.dataset.index} onto ${target.dataset.index}`, 'success');
                        
                        // Visual feedback for successful drop
                        target.style.background = '#2d5016';
                        setTimeout(() => {
                            target.style.background = '';
                        }, 1000);
                    }
                });

                // Drag end handler
                item.addEventListener('dragend', (e) => {
                    if (draggedElement) {
                        draggedElement.classList.remove('dragging');
                        draggedElement = null;
                    }
                    log(`${prefix.toUpperCase()}: Drag ended`);
                });

                // Button click handlers to demonstrate they still work
                const buttons = item.querySelectorAll('.message-actions button');
                buttons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const action = button.className.replace('message-', '').replace('-btn', '');
                        log(`${prefix.toUpperCase()}: ${action} button clicked`, 'info');
                        
                        // Visual feedback
                        button.style.background = '#4CAF50';
                        setTimeout(() => {
                            button.style.background = '';
                        }, 200);
                    });

                    // Prevent dragging when starting on buttons (for the broken version)
                    if (prefix === 'broken') {
                        button.addEventListener('mousedown', (e) => {
                            log(`${prefix.toUpperCase()}: Mouse down on button - drag will likely fail`, 'warning');
                        });
                    }
                });
            });
        }

        // Initialize both test sections
        document.addEventListener('DOMContentLoaded', () => {
            setupDragHandlers(document.getElementById('broken-container'), 'broken');
            setupDragHandlers(document.getElementById('fixed-container'), 'fixed');
            
            log('Test initialized. Try dragging messages in both sections.', 'info');
            log('Notice how the "broken" version fails when action buttons are visible.', 'warning');
            log('The "fixed" version should work consistently.', 'success');
        });

        // Add mouse event tracking to demonstrate the issue
        document.addEventListener('mouseover', (e) => {
            if (e.target.closest('.message-actions')) {
                const section = e.target.closest('#broken-container') ? 'broken' : 'fixed';
                if (section === 'broken') {
                    log('BROKEN: Mouse over action buttons - pointer-events: auto blocks drag events', 'error');
                }
            }
        });
    </script>
</body>
</html>